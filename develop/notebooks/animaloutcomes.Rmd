---
title: "Animal Outcomes"
author: "Brooke Kennedy"
date: "February 1, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#load packages
```{r}
library(tidyr)
library(dplyr)
library(dummies)
library(lubridate)

library(nnet)
```

#read in data
```{r}
train <- read.csv("train.csv", strip.white = TRUE, na.strings=c("","NA"))
train$Train <- rep(1) #to keep track of training and testing set

test <- read.csv("test.csv", strip.white = TRUE, na.strings=c("","NA"))
test$Train <- rep(0)
colnames(test)[1] <- "AnimalID" #rename ID column in test to match train ID column
test$AnimalID <- as.character(test$AnimalID)

df <- bind_rows(train, test)
```

#EDA
```{r}
length(unique(train$Name)) #6,375 unique names, 28% blank

#date range: 2013-10-01 to 2016-02-21

summary(train$OutcomeType)

summary(train$OutcomeSubtype)

summary(train$AnimalType) #cat or dog

summary(train$SexuponOutcome)

length(unique(train$Breed)) #1380 breeds

length(unique(train$Color)) #366 colors

summary(train$AgeuponOutcome)
```

#Data cleansing
```{r}
#Create hasName feature
hasName <- rep(NA, nrow(df))
for(animal in 1:nrow(df)){
  if(is.na(df[animal, 2])){hasName[animal] <- 0}
  else{hasName[animal] <- 1}
}

df <- cbind(df, hasName)


#split age into number and time unit column
df <- separate(df, AgeuponOutcome, c("value", "timeunit"), sep = " ", fill = "right")

#Convert age to same units (weeks)
df$value <- as.numeric(df$value)
df$ageWeeks <- NA
for(animal in 1:nrow(df)){
  if((df[animal, "timeunit"] == 'year'| df[animal, "timeunit"] == 'years') & !is.na(df[animal, "timeunit"])){
    df[animal, "ageWeeks"] <- round(df[animal, "value"] * 52, 2)
  }
  else if((df[animal, "timeunit"] == 'month'| df[animal, "timeunit"] == 'months') & !is.na(df[animal, "timeunit"])){
    df[animal, "ageWeeks"] <- round(df[animal, "value"] * 4, 2) 
  }
  else if((df[animal, "timeunit"] == 'day'| df[animal, "timeunit"] == 'days') & !is.na(df[animal, "timeunit"])){
    df[animal, "ageWeeks"] <- round(df[animal, "value"] /7, 2)
  }
  else{
    df[animal, "ageWeeks"] <- round(df[animal, "value"], 2)
  }
}

#impute missing ages with mean 
df$ageWeeks = ifelse(is.na(df$ageWeeks), mean(df$ageWeeks, na.rm = T), df$ageWeeks)

#Create AnimalType dummy variables (can use just 1 in modeling as isCat or isDog)
df <- cbind(df, dummy(df$AnimalType, sep = "_"))

#Create isMix variable from Breed
df$Breed <- as.character(df$Breed)
df$isMix <- as.numeric(grepl("Mix", df$Breed, ignore.case = TRUE)) #may need to add in pattern for /

#convert DateTime into DateTime
df$DateTime <- strptime(x = as.character(df$DateTime), format = "%Y-%m-%d %H:%M:%S")

#Extract datetime information
df$year <- year(df$DateTime)
df$month <- month(df$DateTime)
df$weekday <- weekdays(df$DateTime)
df$hourOfDay <- hour(df$DateTime)

#Create isFixed variable 
toMatch <- c("Neutered", "Spayed")
matches <- sapply(toMatch, grepl, df$SexuponOutcome, ignore.case=TRUE)
df$isFixed <- as.numeric(apply(matches, 1, any))

#Create gender variable
df <- separate(df, SexuponOutcome, c("fixed", "gender"), sep = " ", fill = "left")
df$gender <- as.factor(df$gender)

#Delete rows where gender = NA (only 1 obs. in df set)
df <- df[!(is.na(df$gender)), ]
```

```{r}
final <- c("AnimalID","OutcomeType", "hasName", "ageWeeks", "df_Dog", "isMix", "year", "month", "weekday", "hourOfDay", "isFixed", "gender", "Train")

finaldf <- df[, colnames(df) %in% final]

#split back into train and test sets
final_train <- finaldf[finaldf$Train == 1, ]
final_test <- finaldf[finaldf$Train == 0, ]


features <- c("OutcomeType", "hasName", "ageWeeks", "df_Dog", "isMix", "year", "month", "weekday", "hourOfDay", "isFixed", "gender")
trainset <- final_train[, colnames(final_train) %in% features]
testset <- final_test[, colnames(final_test) %in% features]
```

#Modeling
```{r}
#logistic regression

out<-multinom(OutcomeType ~ ., trainset, trace=F)
summary(out)

yhat <- predict(out, newdata = testset)

```

```{r}
#initialize submission dataframe
mypreds <- data.frame(matrix(vector(), 11456, 6, dimnames=list(c(), c("ID","Adoption","Died","Euthanasia","Return_to_owner","Transfer"))))
mypreds$ID <- 1:11456
mypreds$Adoption <- 0
mypreds$Died <- 0
mypreds$Euthanasia <- 0
mypreds$Return_to_owner <- 0
mypreds$Transfer <- 0

#fill in based on prediction
for(pred in 1:nrow(mypreds)){
  if(yhat[pred] == "Adoption"){mypreds[pred, "Adoption"] = 1}
  else if(yhat[pred] == "Died"){mypreds[pred, "Died"] = 1}
  else if(yhat[pred] == "Euthanasia"){mypreds[pred, "Euthanasia"] = 1}
  else if(yhat[pred] == "Return_to_owner"){mypreds[pred, "Return_to_owner"] = 1}
  else if(yhat[pred] == "Transfer"){mypreds[pred, "Transfer"] = 1}
}


#print to csv
write.csv(mypreds, file = "MyPreds.csv", row.names = FALSE)
```











